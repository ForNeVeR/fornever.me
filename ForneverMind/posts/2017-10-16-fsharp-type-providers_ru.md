    title: Факты о провайдерах типов F#
    description: Небольшая подборка фактов о F# type providers.
---

На прошлой неделе мы с товарищами из [русскоязычного сообщества
F#-программистов][fsharplang] активно пытались помочь [Дону Сайму][don-syme] с
[портированием][tp-issue] провайдеров типов (type providers) F# на платформу
.NET Core. В итоге вся наша помощь в основном вылилась в моральную поддержку и
обсуждение некоторых деталей, а всю основную работу Дон сделал сам.

В процессе обсуждения вопроса я узнал много нового о провайдерах типов, чем [по
просьбам трудящихся][fsharpchat-question] спешу поделиться с сообществом.
Подборка фактов достаточно разнородная, но, возможно, она поможет читателю чуть
лучше сориентироваться в мире провайдеров типов F#.

1. Провайдеры типов — это механизм, который реализуется двумя частями: одна
   живёт в компиляторе, а вторая живёт в [Type Provider SDK][tp-sdk] (который
   нужно подключать ко всем создаваемым провайдерам). Можно писать провайдеры,
   не пользуясь SDK, но это (кажется) сложнее.

2. Существуют т. н. generative и erased-провайдеры. Generative-провайдеры
   создают настоящие типы, которые потом можно увидеть и из других языков, если
   подключить к ним F#-сборку. Erased-провайдеры ближе к макросам, поскольку
   сгенерированные типы и методы заменяются в итоговой сборке на код, который
   находится внутри них — можно сказать, что они сразу инлайнятся.

3. [По словам][origins] Дона Сайма, изначально провайдеры типов создавались как
   межъязыковой механизм. Generative-провайдеры появились для того, чтобы код
   можно было генерировать на других языках, и отдавать нашему компилятору
   готовые сборки.

4. API для generative- и erased-провайдеров почти не различается — основные
   различия в поведении регулируется одним флагом, который передаётся при
   создании провайдера.

5. Чтобы написать свой провайдер типов, нужно включить в проект несколько файлов
   из Type Provider SDK. Не подключить библиотеку, а именно включить файлы —
   например, скопировав их. Это поначалу кажется весьма неаккуратным, но было
   сделано специально чтобы не добавлять DLL-зависимостей в провайдеры. На
   практике больших проблем не вызывает, поскольку народ делает это достаточно
   аккуратно (например, с помощью Paket), так что копипаста не процветает.

6. Generative-провайдеры во время своего выполнения создают настоящую
   .NET-сборку (которая включает в себя только сгенерированные типы), и отдают
   массив байтов этой сборки компилятору. Компилятор на своей стороне разбирает
   эту сборку и копирует типы из неё в результирующий код (который будет
   включать в себя как сгенерированные типы, так и пользовательский код, к
   которому этот тайп-провайдер был подключен). Долгое время это создавало
   проблемы для работы generative-провайдеров в окружениях, в которых нельзя
   сохранять сгенерированные сборки (.NET Core), и только недавно Дон Сайм
   перенёс часть кода из компилятора в Type Provider SDK, чтобы окончательно
   решить эту проблему. В ближайшее время у нас начнут работать все провайдеры
   под .NET Core.

[don-syme]: https://en.wikipedia.org/wiki/Don_Syme
[fsharpchat-question]: https://t.me/Fsharp_chat/36344
[fsharplang]: http://fsharplang.ru/
[origins]: https://github.com/Microsoft/visualfsharp/issues/2406#issuecomment-335328819
[tp-issue]: https://github.com/Microsoft/visualfsharp/issues/2406
[tp-sdk]: https://github.com/fsprojects/FSharp.TypeProviders.SDK
